package db

const (
	InsertUptreamRegistry               = `INSERT INTO UPSTREAM_REGISTRY(NAME, PORT, STATUS, UPSTREAM_URL) VALUES(?, ?, ?, ?) RETURNING ID`
	InsertUpstreamRegistryAuthConfig    = `INSERT INTO UPSTREAM_REGISTRY_AUTH_CONFIG(REGISTRY_ID, AUTH_TYPE, CREDENTIAL_JSON, TOKEN_ENDPOINT) VALUES(?, ?, ?, ?)`
	InsertUpstreamRegistryStorageConfig = `INSERT INTO UPSTREAM_REGISTRY_STORAGE_CONFIG(REGISTRY_ID, STORAGE_LIMIT, CLEANUP_POLICY, CLEANUP_THRESHOLD_PERCENTAGE) VALUES(?, ?, ?, ?)`
	InsertUpstreamRegistryCacheConfig   = `INSERT INTO UPSTREAM_REGISTRY_CACHE_CONFIG(REGISTRY_ID, ENABLED, TTL_SECONDS, OFFLINE_MODE) VALUES(?, ?, ?, ?)`
	InsertUpstreamRegistryAccessConfig  = `INSERT INTO UPSTREAM_REGISTRY_ACCESS_CONFIG(REGISTRY_ID, PROXY_ENABLED, PROXY_URL, CONNECTION_TIMEOUT, READ_TIMEOUT, MAX_CONNECTIONS, MAX_RETRIES, RETRY_DELAY) VALUES(?, ?, ?, ?, ?, ?, ?, ?)`
	UpdateUpstreamRegistry              = `UPDATE UPSTREAM_REGISTRY SET NAME = ?,  PORT = ?, STATUS = ?, UPSTREAM_URL = ? WHERE ID = ? RETURNING ID`
	UpdateUpstreamRegistryAuthConfig    = `UPDATE UPSTREAM_REGISTRY_AUTH_CONFIG SET AUTH_TYPE = ?, CREDENTIAL_JSON = ?, TOKEN_ENDPOINT = ? WHERE REGISTRY_ID = ?`
	UpdateUpstreamRegistryCacheConfig   = `UPDATE UPSTREAM_REGISTRY_CACHE_CONFIG SET ENABLED = ?, TTL_SECONDS = ?, OFFLINE_MODE = ? WHERE REGISTRY_ID = ?`
	UpdateUpstreamRegistryStorageConfig = `UPDATE UPSTREAM_REGISTRY_STORAGE_CONFIG SET STORAGE_LIMIT = ?, CLEANUP_POLICY = ?, CLEANUP_THRESHOLD_PERCENTAGE = ? WHERE REGISTRY_ID = ?`
	UpdateUpstreamRegistryAccessConfig  = `UPDATE UPSTREAM_REGISTRY_ACCESS_CONFIG SET PROXY_ENABLED = ?, PROXY_URL = ?, CONNECTION_TIMEOUT = ?, READ_TIMEOUT = ?, MAX_CONNECTIONS = ?, MAX_RETRIES = ?, RETRY_DELAY = ? WHERE REGISTRY_ID = ?`
	DeleteUpstreamRegistry              = `DELETE FROM UPSTREAM_REGISTRY WHERE ID = ?`
	DeleteUpstreamRegistryAuthConfig    = `DELETE FROM UPSTREAM_REGISTRY_AUTH_CONFIG WHERE REGISTRY_ID = ?`
	DeleteUpstreamRegistryCacheConfig   = `DELETE FROM UPSTREAM_REGISTRY_CACHE_CONFIG WHERE REGISTRY_ID = ?`
	DeleteUpstreamRegistryStorageConfig = `DELETE FROM UPSTREAM_REGISTRY_STORAGE_CONFIG WHERE REGISTRY_ID = ?`
	DeleteUpstreamRegistryAccessConfig  = `DELETE FROM UPSTREAM_REGISTRY_ACCESS_CONFIG WHERE REGISTRY_ID = ?`
	GetUpstreamRegistryWithConfig       = `SELECT reg.NAME, reg.PORT, reg.UPSTREAM_URL, reg.CREATED_AT, reg.UPDATED_AT,
		auth.AUTH_TYPE, auth.CREDENTIAL_JSON, auth.TOKEN_ENDPOINT, auth.UPDATED_AT,
		access.PROXY_ENABLED, access.PROXY_URL, access.CONNECTION_TIMEOUT, access.READ_TIMEOUT,
		access.MAX_CONNECTIONS, access.MAX_RETRIES, access.RETRY_DELAY, access.UPDATED_AT,
		storage.STORAGE_LIMIT, storage.CLEANUP_POLICY, storage.CLEANUP_THRESHOLD_PERCENTAGE, storage.UPDATED_AT,
		cache.TTL_SECONDS, cache.OFFLINE_MODE, cache.UPDATED_AT
	FROM UPSTREAM_REGISTRY reg
	JOIN UPSTREAM_REGISTRY_AUTH_CONFIG auth ON reg.ID = auth.REGISTRY_ID
	JOIN UPSTREAM_REGISTRY_CACHE_CONFIG cache ON reg.ID = cache.REGISTRY_ID
	JOIN UPSTREAM_REGISTRY_STORAGE_CONFIG storage ON reg.ID = storage.REGISTRY_ID
	JOIN UPSTREAM_REGISTRY_ACCESS_CONFIG access ON reg.ID = access.REGISTRY_ID
	WHERE reg.ID = ?`
	ListUpstreamRegistrySummary = `SELECT ID, NAME, PORT, STATUS, UPSTREAM_URL, CREATED_AT, UPDATED_AT, 0 AS CACHED_IMAGE_COUNT FROM UPSTREAM_REGISTRY`
	GetActiveUpstreamAddresses  = `SELECT ID, NAME, PORT, UPSTREAM_URL FROM UPSTREAM_REGISTRY WHERE STATUS = 'active'`
)

// Namespace
const (
	InsertNamespace      = `INSERT INTO REGISTRY_NAMESPACE(REGISTRY_ID, NAMESPACE) VALUES(?, ?) RETURNING ID`
	GetNamespaceIdByName = `SELECT ID FROM REGISTRY_NAMESPACE WHERE REGISTRY_ID = ? AND NAMESPACE = ?`
)

// Repository
const (
	InsertImageRepository = `INSERT INTO REGISTRY_REPOSITORY(REGISTRY_ID, NAMESPACE_ID, NAME) VALUES(?, ?, ?) RETURNING ID`
	GetRepositoryIdByName = `SELECT ID FROM REGISTRY_REPOSITORY WHERE REGISTRY_ID = ? AND NAMESPACE_ID = ? AND NAME = ?`
)

// ImageBlobMeta
const (
	InsertImageBlobMetaInfo     = `INSERT INTO IMAGE_BLOB_META(REGISTRY_ID, NAMESPACE_ID, REPOSITORY_ID, BLOB_DIGEST, SIZE, STORAGE_LOCATION) VALUES(?, ?, ?, ?, ?, ?)`
	GetImageBlobLocationAndSize = `SELECT STORAGE_LOCATION, SIZE FROM IMAGE_BLOB_META ibm JOIN REGISTRY_NAMESPACE rn ON rn.ID = ibm.NAMESPACE_ID JOIN REGISTRY_REPOSITORY rr ON rr.ID = ibm.REPOSITORY_ID WHERE ibm.REGISTRY_ID = ? AND rn.NAMESPACE = ? AND rr.NAME = ? AND ibm.BLOB_DIGEST = ?`
)

// ImageTag
const (
	InsertImageTag = `INSERT INTO IMAGE_TAG(REGISTRY_ID, NAMESPACE_ID, REPOSITORY_ID, TAG) VALUES(?, ?, ?, ?) RETURNING ID`
	GetImageTagId  = `SELECT ID FROM IMAGE_TAG WHERE REGISTRY_ID = ? AND NAMESPACE_ID = ? AND REPOSITORY_ID = ? AND TAG = ?`
)

// ImageManifest
const (
	InsertImageManifest   = `INSERT INTO IMAGE_MANIFEST(REGISTRY_ID, NAMESPACE_ID, REPOSITORY_ID, DIGEST, MEDIA_TYPE, SIZE, MANIFEST_CONTENT, UNIQUE_DIGEST) VALUES(?, ?, ?, ?, ?, ?, ?, ?) RETURNING ID`
	GetImageManifestByTag = `SELECT im.DIGEST, im.MEDIA_TYPE, im.MANIFEST_CONTENT
		FROM IMAGE_MANIFEST im 
		JOIN IMAGE_MANIFEST_TAG_MAPPING imtm  on imtm.MANIFEST_ID = im.ID
		JOIN IMAGE_TAG it ON it.ID = imtm.TAG_ID
		WHERE im.REGISTRY_ID  = ? AND im.NAMESPACE_ID = ? AND im.REPOSITORY_ID  = ? AND it.TAG = ?`
	CheckImageManifestByTag = `SELECT im.DIGEST, im.MEDIA_TYPE
		FROM IMAGE_MANIFEST im 
		JOIN IMAGE_MANIFEST_TAG_MAPPING imtm  on imtm.MANIFEST_ID = im.ID
		JOIN IMAGE_TAG it ON it.ID = imtm.TAG_ID
		WHERE im.REGISTRY_ID  = ? AND im.NAMESPACE_ID = ? AND im.REPOSITORY_ID  = ? AND it.TAG = ?`
	CheckImageManifestByDigest = `SELECT MEDIA_TYPE FROM IMAGE_MANIFEST WHERE REGISTRY_ID  = ? AND NAMESPACE_ID = ? AND REPOSITORY_ID = ? AND DIGEST = ?`
	GetImageManifestByDigest   = `SELECT MEDIA_TYPE, MANIFEST_CONTENT FROM IMAGE_MANIFEST WHERE REGISTRY_ID  = ? AND NAMESPACE_ID = ? AND REPOSITORY_ID = ? AND DIGEST = ?`

	CheckImageManifestByUniqueDigest = `SELECT ID FROM IMAGE_MANIFEST WHERE REGISTRY_ID  = ? AND NAMESPACE_ID = ? AND REPOSITORY_ID = ? AND UNIQUE_DIGEST = ?`
)

// image-registry-cache
const (
	InsertIntoImageRegistryCache      = `INSERT INTO IMAGE_REGISTRY_CACHE(REGISTRY_ID, NAMESPACE_ID, REPOSITORY_ID, IDENTIFIER, DIGEST, EXPIRES_AT) VALUES(?, ?, ?, ?, ?, ?)`
	DeleteEntryFromImageRegistryCache = `DELETE FROM IMAGE_REGISTRY_CACHE WHERE REGISTRY_ID  = ? AND NAMESPACE_ID = ? AND REPOSITORY_ID = ? AND IDENTIFIER = ?`
	GetEntryFromImageRegistryCache    = `SELECT DIGEST, EXPIRES_AT FROM IMAGE_REGISTRY_CACHE WHERE REGISTRY_ID  = ? AND NAMESPACE_ID = ? AND REPOSITORY_ID = ? AND IDENTIFIER = ?`
	RefreshImageRegistryCacheEntry    = `UPDATE IMAGE_REGISTRY_CACHE SET EXPIRES_AT  = ? WHERE REGISTRY_ID  = ? AND NAMESPACE_ID = ? AND REPOSITORY_ID = ? AND IDENTIFIER = ?`
)

// image-manifest-tag-mapping
const (
	InsertImageManifestTagMapping                 = `INSERT INTO IMAGE_MANIFEST_TAG_MAPPING(MANIFEST_ID, TAG_ID) VALUES(?, ?)`
	UpdateImageManifestTagMappingWitNewManifestId = `UPDATE IMAGE_MANIFEST_TAG_MAPPING SET MANIFEST_ID = ? WHERE TAG_ID = ?`
	GetManifestIdByTagId                          = `SELECT MANIFEST_ID FROM IMAGE_MANIFEST_TAG_MAPPING WHERE TAG_ID = ?`
)
